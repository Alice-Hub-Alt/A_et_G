<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Porte 3 - Les Jauges Corrigées</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

html, body{
  margin:0; padding:0; height:100%;
  font-family:'Press Start 2P', monospace;
  overflow:hidden;
  background:url('https://i.pinimg.com/originals/29/14/97/2914979d57cf620dbf74856235f6f704.gif') center/cover no-repeat;
  user-select: none;
}

/* --- UI GLOBALE --- */

/* Retour */
#back-btn{
  position:fixed; top:14px; left:14px;
  font-size:32px; color:red;
  cursor:pointer; z-index:6000;
  text-shadow: 2px 2px 0px black;
}

/* Dialogue */
#dialogue-box{
  position:fixed;
  left:50%; bottom:26px;
  transform:translateX(-50%);
  width:84%;
  min-height:14vh; max-height:28vh;
  background:rgba(0,0,0,0.55);
  border:3px solid #ff00ff;
  padding:18px;
  color:#ff66ff;
  display:none;
  z-index:9000;
  text-shadow:0 0 6px rgba(255,0,255,0.2);
  overflow:auto;
}
#dialogue-text{ font-size:0.86em; line-height:1.45; }
.cursor-active{
  border-right:0.15em solid #ff66ff;
  animation:blink 0.5s steps(1) infinite;
  padding-right:6px;
}
@keyframes blink{
  0%,100%{border-color:transparent;}
  50%{border-color:#ff66ff;}
}

/* --- LOGIQUE DES JAUGES --- */

#puzzle-container {
  position: fixed;
  top: 45%; left: 50%;
  transform: translate(-50%, -50%);
  width: 90%; max-width: 500px;
  background: rgba(0, 0, 0, 0.7);
  padding: 20px;
  border: 4px solid white;
  text-align: center;
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.slider-row {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  color: white;
  font-size: 0.8em;
  margin-bottom: 5px;
}

.label-wrapper {
    display: flex;
    justify-content: space-between;
    width: 100%;
    margin-bottom: 5px;
}
.label-text {
  text-shadow: 2px 2px 0px #000;
}
.percentage-display {
    color: #FFFFFF; /* Couleur du dialogue pour la cohérence */
    text-shadow: 2px 2px 0px #000;
}

/* Style des Sliders */
input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  height: 20px;
  background: transparent;
  outline: none;
  cursor: pointer;
}

/* La barre (Track) */
input[type=range]::-webkit-slider-runnable-track {
  width: 100%;
  height: 16px;
  border: 2px solid black; /* Contour noir demandé */
  border-radius: 0px;
}
input[type=range]::-moz-range-track {
  width: 100%;
  height: 16px;
  border: 2px solid black;
  border-radius: 0px;
}

/* Le curseur (Thumb) - On le fait ressortir un peu */
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  height: 24px;
  width: 12px;
  background: white;
  border: 2px solid black;
  margin-top: -6px; /* Pour centrer le thumb sur la track */
  box-shadow: 2px 2px 0px rgba(0,0,0,0.5);
}
input[type=range]::-moz-range-thumb {
  height: 24px;
  width: 12px;
  background: white;
  border: 2px solid black;
  box-shadow: 2px 2px 0px rgba(0,0,0,0.5);
}

/* Couleurs spécifiques des jauges */
#range-joie::-webkit-slider-runnable-track { background: #ffff00; }
#range-joie::-moz-range-track { background: #ffff00; }

#range-tristesse::-webkit-slider-runnable-track { background: #0000ff; }
#range-tristesse::-moz-range-track { background: #0000ff; }

#range-peur::-webkit-slider-runnable-track { background: #00ff00; }
#range-peur::-moz-range-track { background: #00ff00; }

#range-colere::-webkit-slider-runnable-track { background: #ff0000; }
#range-colere::-moz-range-track { background: #ff0000; }

#range-cynisme::-webkit-slider-runnable-track { background: #9900cc; } /* Violet */
#range-cynisme::-moz-range-track { background: #9900cc; }

/* Bouton Valider */
#validate-btn {
  margin-top: 15px;
  padding: 15px;
  font-family: 'Press Start 2P', monospace;
  background: black;
  color: white;
  border: 3px solid white;
  cursor: pointer;
  text-transform: uppercase;
  font-size: 0.9em;
  transition: transform 0.1s;
}
#validate-btn:active {
  transform: scale(0.95);
}

/* Image de victoire */
#win-image-container {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 5000;
  display: none;
  /* Suppression des bordures et ombres */
  border: none; 
  box-shadow: none;
}
#win-img {
  display: block;
  max-width: 90vw;
  max-height: 80vh;
}

</style>
</head>

<body>

<div id="back-btn" onclick="location.href='zone2_1.html'">⬅</div>
<audio id="type-sound" src="https://dl.dropboxusercontent.com/scl/fi/r88xcqkfq22gjne9usnea/phoenix-wright-talking-noise-made-with-Voicemod.mp3?rlkey=cuykwz6lmg1wa21zl0aqljobh&dl=0"></audio>

<div id="puzzle-container">
  
  <div class="slider-row">
    <div class="label-wrapper">
        <div class="label-text">JOIE</div>
        <div class="percentage-display" id="perc-joie">50%</div>
    </div>
    <input type="range" id="range-joie" min="0" max="100" value="50" step="5">
  </div>

  <div class="slider-row">
    <div class="label-wrapper">
        <div class="label-text">TRISTESSE</div>
        <div class="percentage-display" id="perc-tristesse">50%</div>
    </div>
    <input type="range" id="range-tristesse" min="0" max="100" value="50" step="5">
  </div>

  <div class="slider-row">
    <div class="label-wrapper">
        <div class="label-text">PEUR</div>
        <div class="percentage-display" id="perc-peur">50%</div>
    </div>
    <input type="range" id="range-peur" min="0" max="100" value="50" step="5">
  </div>

  <div class="slider-row">
    <div class="label-wrapper">
        <div class="label-text">COLÈRE</div>
        <div class="percentage-display" id="perc-colere">50%</div>
    </div>
    <input type="range" id="range-colere" min="0" max="100" value="50" step="5">
  </div>

  <div class="slider-row">
    <div class="label-wrapper">
        <div class="label-text">CYNISME</div>
        <div class="percentage-display" id="perc-cynisme">50%</div>
    </div>
    <input type="range" id="range-cynisme" min="0" max="100" value="50" step="5">
  </div>

  <button id="validate-btn">VALIDER</button>

</div>

<div id="win-image-container">
  <img id="win-img" src="https://i.imgur.com/mGro9Au.png" alt="Victoire">
</div>

<div id="dialogue-box"><div id="dialogue-text"></div></div>

<script>
/* --- CONFIGURATION DU TYPEWRITER --- */
const dialogueBox = document.getElementById("dialogue-box");
const dialogueText = document.getElementById("dialogue-text");
const typeSound = document.getElementById("type-sound");
let typingInterval;
let isTyping = false;
let skipRequested = false;

// Tableau des dialogues d'introduction (MIS À JOUR)
const introDialogues = [
    "Tiens, on dirait un panneau de configuration... Est-ce que c'est censé représenté ma personnalité via les émotions ?",
    "C'est pas un peu simpliste ? Et puis pourquoi cynisme ?! C'est pas une émotion de base ça ! Attention, tu ne peux régler les jauges que par pas de 5 !"
];

// Dialogues de victoire/échec mis à jour
const winDialogue = "A ce point là ?!!! Nan mais c'est bon c'est abusé je suis plus heureuse que ça quand même c'est pas bien fait ce truc !";
const failDialogue = "Ah nan clairement pas c'est n'importe quoi là ! Mais je me conais mal c'est pas ma faute aussi si j'ai pas de recul sur moi même !";


function stopSound(){
  try{ typeSound.pause(); typeSound.currentTime=0; }catch(e){}
}

// Fonction TypeWriter mise à jour avec Callback
function typeWriter(text, callback){
    if(typingInterval) clearInterval(typingInterval);
    skipRequested = false;

    const finalizeTyping = () => {
        clearInterval(typingInterval);
        stopSound();
        dialogueText.classList.remove("cursor-active");
        isTyping = false;
        if(callback) dialogueBox.addEventListener('click', callback, { once:true });
    };

    isTyping = true;
    dialogueText.innerHTML = "";
    dialogueBox.style.display = "block";
    dialogueText.classList.add("cursor-active");
    
    // Jouer le son
    try{ typeSound.play().catch(()=>{});}catch(e){}
    
    let i=0;
    typingInterval = setInterval(()=>{
        if(skipRequested){
            dialogueText.innerHTML = text;
            finalizeTyping();
            return;
        }
        if(i < text.length){
            dialogueText.innerHTML += text.charAt(i++);
        } else {
            finalizeTyping();
        }
    }, 28);
}

// Gestion du skip
dialogueBox.addEventListener("click", (event)=>{
    if(isTyping){
        skipRequested = true;
        event.stopPropagation();
        return;
    }
});

// Fonctions d'enchaînement des dialogues d'introduction
function introSequenceStep2(){
    // On ferme la boîte si le texte est déjà fini (pour éviter de re-cliquer pour la fermer)
    dialogueBox.removeEventListener('click', introSequenceStep2); // Enlève l'écouteur après un clic
    if(isTyping) return; // Sécurité

    // Lance le deuxième dialogue
    typeWriter(introDialogues[1], endIntroSequence);
}

function endIntroSequence(){
    // Une fois que la deuxième phrase est finie et qu'on clique, on ferme la boîte
    dialogueBox.style.display = "none";
    // Supprime l'écouteur d'événement final pour ne pas interférer avec le bouton de validation
    dialogueBox.removeEventListener('click', endIntroSequence); 
}


/* --- LOGIQUE DU PUZZLE --- */

const btnValidate = document.getElementById("validate-btn");
const puzzleContainer = document.getElementById("puzzle-container");
const winContainer = document.getElementById("win-image-container");

// Cibles et marge d'erreur
const targets = {
  joie: 15,
  tristesse: 20,
  peur: 25,
  colere: 10,
  cynisme: 30
};
const margin = 5;

// Elements des jauges et pourcentages
const sliders = {
    joie: document.getElementById("range-joie"),
    tristesse: document.getElementById("range-tristesse"),
    peur: document.getElementById("range-peur"),
    colere: document.getElementById("range-colere"),
    cynisme: document.getElementById("range-cynisme")
};
const displays = {
    joie: document.getElementById("perc-joie"),
    tristesse: document.getElementById("perc-tristesse"),
    peur: document.getElementById("perc-peur"),
    colere: document.getElementById("perc-colere"),
    cynisme: document.getElementById("perc-cynisme")
};

// Fonction pour mettre à jour l'affichage des pourcentages
function updatePercentage(emotion) {
    displays[emotion].textContent = sliders[emotion].value + "%";
}

// Ajouter les écouteurs d'événements pour mettre à jour l'affichage en temps réel
for (const emotion in sliders) {
    sliders[emotion].addEventListener("input", () => updatePercentage(emotion));
    // Mettre à jour l'affichage initial
    updatePercentage(emotion); 
}

// Intro au chargement (Lancement de la première étape de la cinématique)
window.onload = ()=>{
    // Lance le premier dialogue et appelle introSequenceStep2 au clic suivant
    typeWriter(introDialogues[0], introSequenceStep2);
}

btnValidate.addEventListener("click", ()=>{
  // Récupération des valeurs
  let valJoie = parseInt(sliders.joie.value);
  let valTristesse = parseInt(sliders.tristesse.value);
  let valPeur = parseInt(sliders.peur.value);
  let valColere = parseInt(sliders.colere.value);
  let valCynisme = parseInt(sliders.cynisme.value);

  // Vérification avec la marge d'erreur
  const checkValue = (val, target) => (val >= target - margin && val <= target + margin);

  let okJoie = checkValue(valJoie, targets.joie);
  let okTristesse = checkValue(valTristesse, targets.tristesse);
  let okPeur = checkValue(valPeur, targets.peur);
  let okColere = checkValue(valColere, targets.colere);
  let okCynisme = checkValue(valCynisme, targets.cynisme);

  if(okJoie && okTristesse && okPeur && okColere && okCynisme) {
    // VICTOIRE
    puzzleContainer.style.display = "none"; // Cache les jauges
    winContainer.style.display = "block"; // Affiche l'image
    // typeWriter sans callback car on affiche le code, le dialogue peut rester ouvert
    typeWriter(winDialogue, null);
  } else {
    // ECHEC
    // typeWriter sans callback car le dialogue doit rester ouvert jusqu'au clic de l'utilisateur
    typeWriter(failDialogue, null);
  }
});

</script>

</body>
</html>
