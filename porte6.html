<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Porte 6</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

html, body{
  margin:0; padding:0; height:100%;
  font-family:'Press Start 2P', monospace;
  overflow:hidden;
  background:url('https://c.tenor.com/H6Rhs21XAaoAAAAd/tenor.gif') center/cover no-repeat;
  user-select: none;
}

/* --- UI GLOBALE --- */

/* Retour */
#back-btn{
  position:fixed; top:14px; left:14px;
  font-size:32px; color:red;
  cursor:pointer; z-index:6000;
  text-shadow: 2px 2px 0px black;
}

/* Dialogue */
#dialogue-box{
  position:fixed;
  left:50%; bottom:26px;
  transform:translateX(-50%);
  width:84%;
  min-height:14vh; max-height:28vh;
  background:rgba(0,0,0,0.55);
  border:3px solid #ff00ff;
  padding:18px;
  color:#ff66ff;
  display:none;
  z-index:9000;
  text-shadow:0 0 6px rgba(255,0,255,0.2);
  overflow:auto;
}
#dialogue-text{ font-size:0.86em; line-height:1.45; }
.cursor-active{
  border-right:0.15em solid #ff66ff;
  animation:blink 0.5s steps(1) infinite;
  padding-right:6px;
}
@keyframes blink{
  0%,100%{border-color:transparent;}
  50%{border-color:#ff66ff;}
}

/* --- LOGIQUE DE L'INVENTAIRE (D&D) --- */

#main-puzzle-wrapper {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 720px;
    z-index: 100;
}

#titles-wrapper {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    width: 100%;
}

.box-title-text {
    color: white;
    font-size: 0.9em;
    text-shadow: 2px 2px 0px black;
    text-align: center;
    width: 350px;
}

#dnd-container {
    display: flex;
    gap: 20px;
}

.inventory-box {
    width: 350px; 
    height: 400px;
    background: rgba(0, 0, 0, 0.7);
    border: 4px solid white;
    padding: 10px;
    box-sizing: border-box;
    display: flex;
    flex-wrap: wrap;
    align-content: flex-start;
    gap: 10px; 
    position: relative;
    overflow-y: hidden;
}
.inventory-box.dragover {
    border-color: #ff00ff;
    box-shadow: 0 0 10px #ff00ff;
}

/* Conteneur de l'objet déplaçable */
.draggable-item {
    width: 70px; 
    height: 70px;
    cursor: grab;
    transition: transform 0.1s;
    box-sizing: border-box;
    border: 1px solid transparent; 
    display: flex;
    justify-content: center;
    align-items: center;
}
.draggable-item:hover {
    border: 1px solid rgba(255, 255, 255, 0.5); 
}

/* L'image elle-même */
.draggable-item img {
    max-width: 100%; 
    max-height: 100%; 
    width: auto; 
    height: auto; 
    display: block;
    pointer-events: none;
}


/* Bouton Valider */
#validate-btn {
    position: fixed;
    bottom: 20%; 
    left: 50%;
    transform: translateX(-50%);
    padding: 15px;
    font-family: 'Press Start 2P', monospace;
    background: black;
    color: white;
    border: 3px solid white;
    cursor: pointer;
    text-transform: uppercase;
    font-size: 0.9em;
    transition: transform 0.1s;
    z-index: 50;
}
#validate-btn:active {
    transform: translateX(-50%) scale(0.95);
}

/* Image de victoire */
#win-image-container {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 5000;
    display: none;
    border: none; 
    box-shadow: none;
}
#win-img {
    display: block;
    max-width: 90vw;
    max-height: 80vh;
}

</style>
</head>

<body>

<audio id="puzzle-music" loop autoplay>
    <source src="https://www.dropbox.com/scl/fi/th4orqwip07kmesxls2gf/Lost-Forest-High-Quality-Version-Professor-Layton-and-the-Diabolical-Box.mp3?dl=1" type="audio/mpeg">
</audio>

<div id="back-btn" onclick="location.href='zone2_1.html'">⬅</div>
<audio id="type-sound" src="https://dl.dropboxusercontent.com/scl/fi/r88xcqkfq22gjne9usnea/phoenix-wright-talking-noise-made-with-Voicemod.mp3?rlkey=cuykwz6lmg1wa21zl0aqljobh&dl=1"></audio>

<div id="main-puzzle-wrapper">
    
    <div id="titles-wrapper">
        <div class="box-title-text">Essence de l'individualité</div>
        <div class="box-title-text">Identifie sa nature</div>
    </div>
    
    <div id="dnd-container">
        
        <div id="item-source" class="inventory-box">
            </div>
    
        <div id="inventory-target" class="inventory-box">
            </div>

    </div>

</div>

<button id="validate-btn">VALIDER</button>

<div id="win-image-container">
    <img id="win-img" src="https://i.imgur.com/xnhXVcZ.png" alt="Victoire">
</div>

<div id="dialogue-box"><div id="dialogue-text"></div></div>

<script>
const music = document.getElementById("puzzle-music");
const dialogueBox = document.getElementById("dialogue-box");
const dialogueText = document.getElementById("dialogue-text");
const typeSound = document.getElementById("type-sound");
let typingInterval;
let isTyping = false;
let skipRequested = false;

const introDialogues = ["C'est quoi, une sorte de puzzle par trie sélectif de traits de caractères ?", "C'est au masculin, j'imagine que c'est pour Guilian. Toujours à mettre le bazard celui la !"];
const winDialogue = "Il a pleins de défauts, mais c'est aussi pour ça que je l'aime ! Les gens parfait sont ennuyeux !";
const failDialogue = "Mais non mais pas du tout je dit nimp c'est pas du tout lui ça...";

function stopSound(){
  try{ typeSound.pause(); typeSound.currentTime=0; }catch(e){}
}

function closeDialogue(){
    dialogueBox.style.display = "none";
    dialogueBox.removeEventListener('click', closeDialogue); 
}

function typeWriter(text, callback){
    if(typingInterval) clearInterval(typingInterval);
    skipRequested = false;

    const finalizeTyping = () => {
        clearInterval(typingInterval);
        stopSound();
        dialogueText.classList.remove("cursor-active");
        isTyping = false;
        if(callback) dialogueBox.addEventListener('click', callback, { once:true });
    };

    isTyping = true;
    dialogueText.innerHTML = "";
    dialogueBox.style.display = "block";
    dialogueText.classList.add("cursor-active");
    
    try{ typeSound.play().catch(()=>{});}catch(e){}
    
    let i=0;
    typingInterval = setInterval(()=>{
        if(skipRequested){
            dialogueText.innerHTML = text;
            finalizeTyping();
            return;
        }
        if(i < text.length){
            dialogueText.innerHTML += text.charAt(i++);
        } else {
            finalizeTyping();
        }
    }, 28);
}

dialogueBox.addEventListener("click", (event)=>{
    if(isTyping){
        skipRequested = true;
        event.stopPropagation();
        return;
    }
});

function introSequenceStep2(){
    typeWriter(introDialogues[1], endIntroSequence);
}

function endIntroSequence(){
    dialogueBox.style.display = "none";
    dialogueBox.removeEventListener('click', endIntroSequence); 
}

window.onload = ()=>{
    music.play().catch(() => {
        console.log("Lecture auto bloquée, elle démarrera au premier clic.");
    });
    setupInventory();
    typeWriter(introDialogues[0], introSequenceStep2);
}


// --- LOGIQUE DU PUZZLE D&D ---

const itemSource = document.getElementById('item-source');
const inventoryTarget = document.getElementById('inventory-target');
const btnValidate = document.getElementById('validate-btn');
const winContainer = document.getElementById('win-image-container');

const coreItems = [
    { id: 'gentillesse', name: 'Gentillesse', src: 'https://i.imgur.com/LMsf1Ls.png', type: 'core' },
    { id: 'naivete', name: 'Naïveté', src: 'https://i.imgur.com/oarptPK.png', type: 'core' },
    { id: 'imagination', name: 'Imagination', src: 'https://i.imgur.com/QsxRiq8.png', type: 'core' },
    { id: 'determination', name: 'Détermination', src: 'https://i.imgur.com/bnhctZw.png', type: 'core' },
    { id: 'entetement', name: 'Entêtement', src: 'https://i.imgur.com/4R9PzPz.png', type: 'core' },
    { id: 'sentiments', name: 'Sentimentalilé', src: 'https://i.imgur.com/nSsHglB.png', type: 'core' },
    { id: 'impulsivite', name: 'Impulsivité', src: 'https://i.imgur.com/kfnToUT.png', type: 'core' },
    { id: 'hatif', name: 'Hâtivement', src: 'https://i.imgur.com/PBuSRTi.png', type: 'core' },
];

const parasiteItems = [
    { id: 'discernement', name: 'Discernement', src: 'https://i.imgur.com/uqIqkuK.png', type: 'parasite' },
    { id: 'loquacite', name: 'Loquacité', src: 'https://i.imgur.com/dQu6Lga.png', type: 'parasite' },
    { id: 'susceptibilite', name: 'Susceptibilité', src: 'https://i.imgur.com/MLOLl1y.png', type: 'parasite' }, 
    { id: 'tyrannie', name: 'Autoritaire', src: 'https://i.imgur.com/fc4QXTq.png', type: 'parasite' }
];

function getShuffledItems() {
    let allItems = [];
    let coreIndex = 0;
    let parasiteIndex = 0;

    const orderPattern = [
        { type: 'core', count: 2 },
        { type: 'parasite', count: 1 },
        { type: 'core', count: 1 },
        { type: 'parasite', count: 1 },
        { type: 'core', count: 2 },
        { type: 'parasite', count: 1 },
        { type: 'core', count: 1 },
        { type: 'parasite', count: 1 },
        { type: 'core', count: 2 }
    ];

    orderPattern.forEach(part => {
        for (let i = 0; i < part.count; i++) {
            if (part.type === 'core' && coreIndex < coreItems.length) {
                allItems.push(coreItems[coreIndex++]);
            } else if (part.type === 'parasite' && parasiteIndex < parasiteItems.length) {
                allItems.push(parasiteItems[parasiteIndex++]);
            }
        }
    });

    return allItems;
}


let draggedItem = null;

function setupInventory() {
    const itemsToDisplay = getShuffledItems();

    itemsToDisplay.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'draggable-item';
        itemDiv.setAttribute('draggable', true);
        itemDiv.id = item.id;
        itemDiv.title = item.name; 
        itemDiv.dataset.type = item.type; 

        const img = document.createElement('img');
        img.src = item.src;
        img.alt = item.name;

        itemDiv.appendChild(img);
        itemSource.appendChild(itemDiv);
    });

    addDragListeners();
}

function addDragListeners() {
    document.querySelectorAll('.draggable-item').forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
    });

    const dropZones = [itemSource, inventoryTarget];
    dropZones.forEach(zone => {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('dragenter', handleDragEnter);
        zone.addEventListener('dragleave', handleDragLeave);
        zone.addEventListener('drop', handleDrop);
    });
}

function handleDragStart(e) {
    draggedItem = this;
    e.dataTransfer.effectAllowed = 'move';
    setTimeout(() => this.style.opacity = '0.5', 0); 
}

function handleDragEnd(e) {
    this.style.opacity = '1';
    draggedItem = null;
    document.querySelectorAll('.inventory-box').forEach(box => {
        box.classList.remove('dragover');
    });
}

function handleDragOver(e) {
    e.preventDefault(); 
    e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
    e.preventDefault();
    this.classList.add('dragover');
}

function handleDragLeave(e) {
    this.classList.remove('dragover');
}

function handleDrop(e) {
    e.stopPropagation(); 
    this.classList.remove('dragover');

    if (draggedItem) {
        this.appendChild(draggedItem);
    }
}


btnValidate.addEventListener('click', ()=>{
    
    const itemsInInventory = inventoryTarget.querySelectorAll('.draggable-item');
    
    let coreItemsCount = 0;
    let parasiteItemsCount = 0;

    itemsInInventory.forEach(item => {
        if (item.dataset.type === 'core') {
            coreItemsCount++;
        } else if (item.dataset.type === 'parasite') {
            parasiteItemsCount++;
        }
    });

    const totalCoreItems = coreItems.length; 
    
    const victory = (coreItemsCount === totalCoreItems) && (parasiteItemsCount === 0);

    if (victory) {
        document.getElementById('main-puzzle-wrapper').style.display = "none";
        btnValidate.style.display = "none";
        winContainer.style.display = "block"; 
        typeWriter(winDialogue, closeDialogue);
    } else {
        typeWriter(failDialogue, closeDialogue); 
    }
});

</script>

</body>
</html>
