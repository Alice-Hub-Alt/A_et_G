<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Porte 7 - Rune GA</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

html, body{
    margin:0; padding:0; height:100%;
    font-family:'Press Start 2P', monospace;
    overflow:hidden;
    /* Nouveau fond GIF */
    background:url('https://i.redd.it/5oqqs8imr6s41.gif') center/cover no-repeat;
    background-size: cover; 
    user-select: none;
}

/* --- UI GLOBALE --- */

#back-btn{
    position:fixed; top:14px; left:14px;
    font-size:32px; color:red;
    cursor:pointer; z-index:6000;
    text-shadow: 2px 2px 0px black;
}

#dialogue-box{
    position:fixed;
    left:50%; bottom:26px;
    transform:translateX(-50%);
    width:84%;
    min-height:14vh; max-height:28vh;
    background:rgba(0,0,0,0.55);
    border:3px solid #ff00ff;
    padding:18px;
    color:#ff66ff;
    display:none;
    z-index:9000;
    text-shadow:0 0 6px rgba(255,0,255,0.2);
    overflow:auto;
}
#dialogue-text{ font-size:0.86em; line-height:1.45; }
.cursor-active{
    border-right:0.15em solid #ff66ff;
    animation:blink 0.5s steps(1) infinite;
    padding-right:6px;
}
@keyframes blink{
    0%,100%{border-color:transparent;}
    50%{border-color:#ff66ff;}
}

/* --- LOGIQUE DU PUZZLE (Rune GA) --- */

#puzzle-container {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    text-align: center;
}

#canvas-wrapper {
    position: relative;
    border: 4px solid white;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    display: inline-block;
    width: 400px;
    height: 360px;
}

#rune-canvas {
    background-color: rgba(0, 0, 0, 0.8);
    display: block;
}

.connection-point {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    z-index: 10; 
    transition: background-color 0.1s;
    transform: translate(-50%, -50%); 
}

.connection-point:hover::after {
    content: attr(title);
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    background: black;
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 0.6em;
    white-space: nowrap;
    z-index: 100;
    border: 1px solid white;
}

.connection-point.selected {
    background-color: #ff00ff; 
    border: 2px solid white;
    box-shadow: 0 0 8px #ff00ff;
}

.box-title-text {
    color: white;
    font-size: 0.9em;
    text-shadow: 2px 2px 0px black;
    text-align: center;
    margin-bottom: 20px;
}

#validate-btn {
    position: fixed;
    bottom: 20%; 
    left: 50%;
    transform: translateX(-50%);
    padding: 15px;
    font-family: 'Press Start 2P', monospace;
    background: black;
    color: white;
    border: 3px solid white;
    cursor: pointer;
    text-transform: uppercase;
    font-size: 0.9em;
    transition: transform 0.1s;
    z-index: 50;
}
#validate-btn:active {
    transform: translateX(-50%) scale(0.95);
}

#win-image-container {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 5000;
    display: none;
}
#win-img {
    display: block;
    max-width: 90vw;
    max-height: 80vh;
}

</style>
</head>

<body>

<div id="back-btn" onclick="location.href='zone2_1.html'">⬅</div>
<audio id="type-sound" src="https://dl.dropboxusercontent.com/scl/fi/r88xcqkfq22gjne9usnea/phoenix-wright-talking-noise-made-with-Voicemod.mp3?rlkey=cuykwz6lmg1wa21zl0aqljobh&dl=0"></audio>

<div id="puzzle-container">
    <div class="box-title-text" style="color:#ff00ff;">Tracez notre Symbole : La Rune GA</div>
    
    <div id="canvas-wrapper">
        <canvas id="rune-canvas" width="400" height="360"></canvas>
    </div>
</div>

<button id="validate-btn">VALIDER</button>

<div id="win-image-container">
    <img id="win-img" src="https://i.imgur.com/xnhXVcZ.png" alt="Victoire">
</div>

<div id="dialogue-box"><div id="dialogue-text"></div></div>

<script>
// --- CONFIGURATION DU TYPEWRITER ---

const dialogueBox = document.getElementById("dialogue-box");
const dialogueText = document.getElementById("dialogue-text");
const typeSound = document.getElementById("type-sound");
let typingInterval;
let isTyping = false;
let skipRequested = false;

const introDialogues = ["C'est quoi, une sorte de puzzle par trie sélectif de traits de caractères ?", "C'est au masculin, j'imagine que c'est pour Guilian. Toujours à mettre le bazard celui la !"];
const winDialogue = "Youhou je le connais trop bien je suis juste trop forte en fait !";
const failDialogue = "Mais non mais pas du tout je dit nimp c'est pas du tout lui ça...";

function stopSound(){
  try{ typeSound.pause(); typeSound.currentTime=0; }catch(e){}
}

function closeDialogue(){
    dialogueBox.style.display = "none";
}

function typeWriter(text, callback){
    if(typingInterval) clearInterval(typingInterval);
    skipRequested = false;
    dialogueBox.onclick = null; 
    
    const finalizeTyping = () => {
        clearInterval(typingInterval);
        stopSound();
        dialogueText.classList.remove("cursor-active");
        isTyping = false;
        dialogueBox.onclick = callback || closeDialogue;
    };

    const handleInteraction = (event) => {
        if(isTyping){
            skipRequested = true;
            event.stopPropagation();
        } else {
            if (dialogueBox.onclick) dialogueBox.onclick();
        }
    };

    isTyping = true;
    dialogueText.innerHTML = "";
    dialogueBox.style.display = "block";
    dialogueText.classList.add("cursor-active");
    
    try{ typeSound.play().catch(()=>{});}catch(e){}
    
    let i=0;
    typingInterval = setInterval(()=>{
        if(skipRequested){
            dialogueText.innerHTML = text;
            finalizeTyping();
            return;
        }
        if(i < text.length){
            dialogueText.innerHTML += text.charAt(i++);
        } else {
            finalizeTyping();
        }
    }, 28);

    dialogueBox.onclick = handleInteraction;
}

function introSequenceStep2(){
    typeWriter(introDialogues[1], endIntroSequence);
}

function endIntroSequence(){
    dialogueBox.style.display = "none";
}

window.onload = ()=>{
    setupRunePuzzle();
    typeWriter(introDialogues[0], introSequenceStep2);
}


// --- LOGIQUE DU PUZZLE RUNE GA (AVEC PATCH GÉOMÉTRIQUE) ---

const canvas = document.getElementById('rune-canvas');
const ctx = canvas.getContext('2d');
const wrapper = document.getElementById('canvas-wrapper');
const btnValidate = document.getElementById('validate-btn');
const winContainer = document.getElementById('win-image-container');

const GRID_COLS = 10;
const GRID_ROWS = 9;
const SPACING = 40;
const START_OFFSET = SPACING / 2; 

let POINTS_CONFIG = [];
let pointCounter = 1;

for (let y = 0; y < GRID_ROWS; y++) {
    for (let x = 0; x < GRID_COLS; x++) {
        POINTS_CONFIG.push({
            id: `P${pointCounter}`, 
            x: START_OFFSET + x * SPACING,
            y: START_OFFSET + y * SPACING,
        });
        pointCounter++;
    }
}

const SOLUTION_LINES_IDS = [
    'P23_P43', 'P5_P23', 'P5_P27', 'P27_P35', 
    'P35_P45', 'P43_P48', 'P53_P73', 'P55_P67', 'P55_P85'
]; 

let userLines = []; 
let selectedPoint = null; 

function getPointById(id) {
    return POINTS_CONFIG.find(p => p.id === id);
}

// FONCTION DU PATCH : Normalisation
function normalize(a, b){
    if(a.x < b.x || (a.x === b.x && a.y <= b.y)){
        return {x1:a.x, y1:a.y, x2:b.x, y2:b.y};
    }
    return {x1:b.x, y1:b.y, x2:a.x, y2:a.y};
}

// FONCTION DU PATCH : Comparaison
function sameLine(a, b){
    return Math.abs(a.x1 - b.x1) < 1 &&
           Math.abs(a.y1 - b.y1) < 1 &&
           Math.abs(a.x2 - b.x2) < 1 &&
           Math.abs(a.y2 - b.y2) < 1;
}

// Pré-calcul de la solution géométrique
const SOLUTION_GEOMETRY = SOLUTION_LINES_IDS.map(idPair => {
    const ids = idPair.split('_');
    const pA = getPointById(ids[0]);
    const pB = getPointById(ids[1]);
    return normalize(pA, pB);
});

function drawCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    
    userLines.forEach(line => {
        ctx.beginPath();
        ctx.moveTo(line.x1, line.y1);
        ctx.lineTo(line.x2, line.y2);
        ctx.stroke();
    });
}

function handlePointClick() {
    const pointId = this.id;
    const currentPointData = getPointById(pointId);

    if (!selectedPoint) {
        selectedPoint = pointId;
        this.classList.add('selected');
    } 
    else if (selectedPoint === pointId) {
        selectedPoint = null;
        this.classList.remove('selected');
    }
    else {
        const prevPointData = getPointById(selectedPoint);
        const newLine = normalize(prevPointData, currentPointData);
        
        // Toggle de la ligne
        const existingIndex = userLines.findIndex(l => sameLine(l, newLine));
        if (existingIndex !== -1) {
            userLines.splice(existingIndex, 1);
        } else {
            userLines.push(newLine);
        }

        document.getElementById(selectedPoint).classList.remove('selected');
        selectedPoint = null;
        drawCanvas();
    }
}

function setupRunePuzzle() {
    POINTS_CONFIG.forEach(point => {
        const pointDiv = document.createElement('div');
        pointDiv.className = 'connection-point';
        pointDiv.id = point.id;
        pointDiv.style.left = point.x + 'px';
        pointDiv.style.top = point.y + 'px';
        pointDiv.title = point.id.substring(1);
        pointDiv.addEventListener('click', handlePointClick);
        wrapper.appendChild(pointDiv);
    });
    drawCanvas(); 
}

// --- VALIDATION DU PUZZLE ---

btnValidate.addEventListener('click', ()=>{
    // Vérification géométrique complète
    const isCorrectSize = userLines.length === SOLUTION_GEOMETRY.length;
    
    const allFound = SOLUTION_GEOMETRY.every(sLine => 
        userLines.some(uLine => sameLine(uLine, sLine))
    );

    const victory = isCorrectSize && allFound;

    if (victory) {
        document.getElementById('puzzle-container').style.display = "none";
        btnValidate.style.display = "none";
        winContainer.style.display = "block"; 
        typeWriter(winDialogue);
    } else {
        typeWriter(failDialogue);
    }
});

</script>

</body>
</html>
