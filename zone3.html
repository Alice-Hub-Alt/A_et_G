<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zone 3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body {
            /* Fond de départ : Spooky */
            background-image: url('https://neocardmaker.com/uploads/monthly_2019_10/1502293590_Spooky2.gif.aa0118140c56d49b8ecc4294d9e4bd34.gif');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: center center;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            font-family: 'Press Start 2P', monospace;
            overflow: hidden;
            background-color: black; 
            transition: background-image 1s ease-in-out;
        }

        #intro-overlay-zone2 {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: black; 
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3);
            text-align: center;
            padding: 20px;
        }

        #dialogue-box, #thought-box {
            width: 90%;
            box-sizing: border-box;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000; /* Z-index très haut pour passer au dessus des glitchs */
            padding: 20px;
            display: none;
        }

        #dialogue-box {
            height: 20vh;
            background-color: rgba(0,0,0,0.85);
            border: 3px solid white;
            cursor: pointer;
        }

        #dialogue-text {
            font-size: 0.8em;
            line-height: 1.5;
            white-space: normal;
            overflow: hidden;
            height: 100%;
        }

        #thought-box {
            background-color: rgba(0,0,0,0.7);
            border: 2px dashed #ff00ff;
            padding: 15px;
            cursor: pointer;
        }

        #thought-text {
            font-size: 0.7em;
            color: #ff00ff;
            line-height:1.5;
        }

        .cursor-active {
            border-right: 0.15em solid white;
            animation: blink-cursor 0.5s step-end infinite;
        }
        @keyframes blink-cursor {
            from, to { border-color: transparent; }
            50% { border-color: white; }
        }

        .conv-screen {
            display: none;
            position: fixed; /* Fixed pour être sûr qu'elles soient centrées même avec des glitchs */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 70%;
            height: auto;
            border: 3px solid white;
            z-index: 2500;
            cursor: pointer;
        }

        /* Style spécifique pour les glitchs */
        .glitch-gif {
            position: absolute;
            pointer-events: none;
            opacity: 0.9;
        }

        /* Fondu au noir pour la fin */
        #fade-black {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: black;
            opacity: 0;
            pointer-events: none;
            transition: opacity 2s;
            z-index: 5000;
        }
    </style>
</head>

<body>
    <audio id="audio-fear" loop>
        <source src="https://www.dropbox.com/scl/fi/v745wspc750tckh9kkjux/AMBIANCE-SONORE-QUI-FAIT-PEUR-pluie-orage-vents-grincements-chuchotements-bizarres....mp3?dl=1" type="audio/mpeg">
    </audio>
    <audio id="audio-peace" loop>
        <source src="https://www.dropbox.com/scl/fi/c12x3k9zwrnf1chexzeqq/Nightingale-singing-The-best-bird-song-in-the-world-Luscinia-megarhynchos.mp3?dl=1" type="audio/mpeg">
    </audio>
    
    <audio id="type-sound" src="https://dl.dropboxusercontent.com/scl/fi/axdo9itskfifhv6d5d1av/Machine-crire-Bruitage-gratuit-et-libre-Effects-sonores.mp3?dl=1"></audio>
    <audio id="type-sound-thought" src="https://dl.dropboxusercontent.com/scl/fi/r88xcqkfq22gjne9usnea/phoenix-wright-talking-noise-made-with-Voicemod.mp3?dl=1"></audio>

    <div id="intro-overlay-zone2">
        ... <br><br>
        (Cliquer pour commencer)
    </div>

    <div id="dialogue-box"><span id="dialogue-text"></span></div>
    <div id="thought-box"><span id="thought-text"></span></div>

    <img id="img1" class="conv-screen" src="https://i.imgur.com/LHb0oXX.png" alt="Screen 1">
    <img id="img2" class="conv-screen" src="https://i.imgur.com/eUtYYag.png" alt="Screen 2">
    <img id="img3" class="conv-screen" src="https://i.imgur.com/72KkopR.png" alt="Screen 3">
    <img id="img4" class="conv-screen" src="https://i.imgur.com/beA11BA.png" alt="Screen 4">
    <img id="img5" class="conv-screen" src="https://i.imgur.com/oBwbwxW.png" alt="Screen 5">
    <img id="img6" class="conv-screen" src="https://i.imgur.com/kuEm3Fv.png" alt="Screen 6">

    <div id="fade-black"></div>

    <script>
        // --- Données de la séquence ---
        const dialogueSequence = [
            { text: "Oula, c'est, particulier disons...", type: "thought", action: "show_thought" },
            { text: "Alice fut abasourdie, elle qui pensais être tiré d'affaire était en fait sur le point de réellement sombrer.", type: "narrator", action: "dialogue" },
            { text: "Ah bah t'es de retour toi !", type: "thought", action: "show_thought" },
            { text: "Et encourageant en plus !", type: "thought", action: "show_thought" },
            { text: "Alice avais beau se cacher sous son sarcasme, elle était terrorisée.", type: "narrator", action: "dialogue" },
            
            // Premier Glitch (Moyen)
            { action: "glitch", count: 25, size: "medium" },
            
            { text: "Et elle avais raison d'avoir aussi peur, car elle savais très bien qu'un jour ça finirais par se produire.", type: "narrator", action: "dialogue" },
            { text: "Euh, quoi ?", type: "thought", action: "show_thought" },
            { text: "Guilian t'abandonne Alice.", type: "narrator", action: "dialogue" },
            { text: "Ta vie est fini, abandonne, arrête d'essayer d'être heureuse, c'est vain.", type: "narrator", action: "dialogue" },
            { text: "Oui, je sais.", type: "thought", action: "show_thought" },
            
            // Deuxième Glitch (Massif)
            { action: "glitch", count: 80, size: "heavy" },
            
            { text: "Je commence à me sentir mal là, arrête.", type: "thought", action: "show_thought" },
            { text: "Alice savais que je ne fessais que dire la vérité mais continuais de nier.", type: "narrator", action: "dialogue" },
            { text: "Non par pitié, je t'en supplie, ARRÊTE.", type: "thought", action: "show_thought" },
            
            { image: "img1", action: "show_image_click_to_continue" },
            { text: "Quoi ? T'es pas censé m'avoir abandonné toi ?", type: "thought", action: "show_thought" },
            { text: "Arrête de faire semblant de m'aimer, je sais que je ne te mérite pas.", type: "thought", action: "show_thought" },
            
            { image: "img2", action: "show_image_click_to_continue" },
            { image: "img3", action: "show_image_click_to_continue" },
            { text: "Je me déteste.", type: "thought", action: "show_thought" },
            { image: "img4", action: "show_image_click_to_continue" },
            
            // On enlève un peu de glitchs pour voir les images
            { action: "clean_glitch_partial" },
            
            { text: "Belle formulation j'avoue, t'es doué.", type: "thought", action: "show_thought" },
            { text: "Mais ça ne changera pas le fait que je suis qu'une merde.", type: "thought", action: "show_thought" },
            
            { image: "img5", action: "show_image_click_to_continue" },
            { text: "Merci beaucoup, je sais pas ce que je ferais sans toi...", type: "thought", action: "show_thought" },
            
            // Changement d'ambiance
            { action: "change_bg" },
            
            { image: "img6", action: "show_image_click_to_continue" },
            { action: "show_end_button" }
        ];

        let currentSequenceIndex = 0;
        let activeImageElement = null;
        let typingInterval;
        let isTyping = false;
        let skipRequested = false;

        const dialogueBox = document.getElementById('dialogue-box');
        const dialogueTextElement = document.getElementById('dialogue-text');
        const thoughtBox = document.getElementById('thought-box');
        const thoughtTextElement = document.getElementById('thought-text');
        const overlay = document.getElementById('intro-overlay-zone2');
        
        // Audio
        const audioFear = document.getElementById('audio-fear');
        const audioPeace = document.getElementById('audio-peace');
        const typeSound = document.getElementById('type-sound');
        const typeSoundThought = document.getElementById('type-sound-thought');

        typeSound.volume = 0.5;
        typeSoundThought.volume = 0.5;

        // Bouton Fin
        const endButton = document.createElement('button');
        endButton.textContent = "Se réveiller";
        endButton.style.padding = "15px 30px";
        endButton.style.fontFamily = "'Press Start 2P', monospace";
        endButton.style.fontSize = "0.9em";
        endButton.style.backgroundColor = "#ff00ff";
        endButton.style.color = "black";
        endButton.style.border = "3px solid white";
        endButton.style.cursor = "pointer";
        endButton.style.position = "fixed";
        endButton.style.top = "50%";
        endButton.style.left = "50%";
        endButton.style.transform = "translate(-50%, -50%)";
        endButton.style.zIndex = "6000";
        endButton.style.display = "none";
        document.body.appendChild(endButton);

        // --- Fonctions Glitch ---
        function spawnGlitch(count, size) {
            for (let i = 0; i < count; i++) {
                const g = document.createElement("img");
                g.src = "https://i.imgur.com/UsrQHo8.gif";
                g.className = "glitch-gif";
                g.style.top = Math.random() * 90 + "vh";
                g.style.left = Math.random() * 90 + "vw";
                
                if (size === 'medium') {
                    const s = Math.floor(Math.random() * 150) + 100;
                    g.style.width = s + "px";
                    g.style.zIndex = 1000;
                } else {
                    const s = Math.floor(Math.random() * 300) + 200;
                    g.style.width = s + "px";
                    g.style.zIndex = Math.floor(Math.random() * 50) + 1500;
                }
                document.body.appendChild(g);
            }
        }

        function removeGlitch(percent) {
            const gifs = document.querySelectorAll(".glitch-gif");
            const count = Math.floor(gifs.length * percent);
            for (let i = gifs.length - 1; i >= gifs.length - count; i--) {
                if(gifs[i]) gifs[i].remove();
            }
        }

        // --- Fonctions Moteur ---

        function skipText(e){
            if(isTyping){
                skipRequested = true;
                e.stopPropagation();
            }
        }

        function typeWriter(text, targetElement, isThought, callback){
            if(typingInterval) clearInterval(typingInterval);
            skipRequested = false;
            isTyping = true;
            targetElement.innerHTML = '';
            targetElement.classList.add('cursor-active');

            let soundEl = isThought ? typeSoundThought : typeSound;
            
            let i=0;
            typingInterval = setInterval(()=>{
                if(skipRequested){
                    targetElement.innerHTML = text;
                    finalizeTyping();
                    return;
                }
                if(i<text.length){
                    // On joue le son à chaque caractère pour l'effet de texte
                    if(soundEl) {
                        soundEl.currentTime = 0;
                        soundEl.play().catch(()=>{});
                    }
                    targetElement.innerHTML += text.charAt(i++);
                } else {
                    finalizeTyping();
                }
            }, 28);

            function finalizeTyping(){
                clearInterval(typingInterval);
                targetElement.classList.remove('cursor-active');
                if(soundEl){ soundEl.pause(); soundEl.currentTime=0; }
                isTyping=false;
                if(callback) callback();
            }
        }

        function hideActiveImage(callback){
            if(activeImageElement){
                activeImageElement.style.opacity=0;
                setTimeout(()=>{
                    activeImageElement.style.display='none';
                    activeImageElement=null;
                    if(callback) callback();
                }, 500); 
            } else if(callback) callback();
        }

        function showImageAndAwaitClick(imageId){
            hideActiveImage(()=>{
                const img=document.getElementById(imageId);
                img.style.display='block';
                activeImageElement=img;
                setTimeout(()=>{
                    img.style.opacity=1;
                    img.addEventListener('click', advanceSequence, {once:true});
                }, 50);
            });
        }

        function showThought(text){
            hideActiveImage(()=>{
                dialogueBox.style.display='none';
                thoughtBox.style.display='block';
                // Retirer les anciens listeners pour éviter les conflits
                const newThoughtBox = thoughtBox.cloneNode(true);
                thoughtBox.parentNode.replaceChild(newThoughtBox, thoughtBox);
                
                const currentThoughtBox = document.getElementById('thought-box');
                const currentThoughtText = document.getElementById('thought-text');
                
                currentThoughtBox.addEventListener('click', skipText, false);
                typeWriter(text, currentThoughtText, true, ()=>{
                    currentThoughtBox.addEventListener('click', hideThoughtAndContinue, {once:true});
                });
            });
        }

        function hideThoughtAndContinue(){
            if(isTyping) return;
            document.getElementById('thought-box').style.display='none';
            advanceSequence();
        }

        function advanceSequence(){
            if(isTyping) return;
            dialogueBox.style.display='none';
            document.getElementById('thought-box').style.display='none';
            
            if(currentSequenceIndex>=dialogueSequence.length) return;

            const evt=dialogueSequence[currentSequenceIndex++];

            if(evt.action==="dialogue"){
                hideActiveImage(()=>{
                    dialogueBox.style.display='block';
                    // Reset listeners
                    const newBox = dialogueBox.cloneNode(true);
                    dialogueBox.parentNode.replaceChild(newBox, dialogueBox);
                    const currentBox = document.getElementById('dialogue-box');
                    const currentText = document.getElementById('dialogue-text');

                    currentBox.addEventListener('click', skipText, false);
                    typeWriter(evt.text, currentText, false, ()=>{
                        currentBox.addEventListener('click', advanceSequence, {once:true});
                    });
                });
            } else if(evt.action==="show_thought"){
                showThought(evt.text);
            } else if(evt.action==="show_image_click_to_continue"){
                showImageAndAwaitClick(evt.image);
            } else if(evt.action==="glitch"){
                spawnGlitch(evt.count, evt.size);
                advanceSequence();
            } else if(evt.action==="clean_glitch_partial"){
                removeGlitch(0.5);
                advanceSequence();
            } else if(evt.action==="change_bg"){
                document.body.style.backgroundImage = "url('https://c.tenor.com/wIa91mot0tAAAAAd/tenor.gif')";
                removeGlitch(1);
                audioFear.pause();
                audioPeace.play().catch(()=>{});
                setTimeout(advanceSequence, 1500);
            } else if(evt.action==="show_end_button"){
                hideActiveImage(()=>{
                    document.getElementById('fade-black').style.opacity = 1;
                    setTimeout(() => {
                        endButton.style.display='block';
                        endButton.addEventListener('click', ()=>{
                            window.location.href='fin.html';
                        }, {once:true});
                    }, 1500);
                });
            }
        }

        overlay.addEventListener('click', ()=>{
            overlay.style.display='none';
            audioFear.play().catch(()=>{});
            advanceSequence();
        }, {once:true});
    </script>
</body>
</html>
