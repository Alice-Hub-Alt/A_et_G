<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zone 3 : C'est la merde</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

body {
    background-image: url('https://neocardmaker.com/uploads/monthly_2019_10/1502293590_Spooky2.gif.aa0118140c56d49b8ecc4294d9e4bd34.gif');
    background-size: cover;
    background-repeat: no-repeat;
    margin: 0;
    overflow: hidden;
    font-family: 'Press Start 2P', cursive;
}

.scene-img {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: none;
    z-index: 5000;
}

#final-button {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 15px 30px;
    font-size: 1em;
    background: black;
    color: white;
    border: 3px solid white;
    cursor: pointer;
    z-index: 6000;
    display: none;
    transition: opacity 0.5s;
}

.glitch-gif {
    position: fixed;
    width: 250px;
    height: 250px;
    z-index: 4000;
}
</style>
</head>
<body>
<div id="intro-overlay-zone2" style="position:fixed;top:0;left:0;width:100%;height:100%;background:black;z-index:7000;"></div>

<img id="img5" class="scene-img" src="https://i.imgur.com/oBwbwxW.png">
<img id="img6" class="scene-img" src="https://i.imgur.com/kuEm3Fv.png">

<button id="final-button" onclick="window.location.href='fin.html'">Dormir</button>

<script>
/* ---------------------- VARIABLES ---------------------- */
let currentImageShown = null;
let usedPositions = [];
const GIF_SIZE = 250; // Taille plus grande pour couvrir l'écran
const MAX_GIFS = 10; // On ne met qu'une dizaine

/* ---------------------- IMAGE ---------------------- */
function showImage(id) {
    hideAllImages();
    const img = document.getElementById(id);
    img.style.display = "block";
    currentImageShown = img;
    document.body.addEventListener('click', hideImageAndContinue, {once: true, capture: true});
}

function hideAllImages() {
    document.querySelectorAll(".scene-img").forEach(img => img.style.display = "none");
    currentImageShown = null;
}

function hideImageAndContinue(e) {
    hideAllImages();
    document.body.removeEventListener('click', hideImageAndContinue, true);
    next();
    e.stopPropagation();
}

/* ---------------------- GLITCH ---------------------- */
function getRandomPosition() {
    const cols = Math.floor(window.innerWidth / GIF_SIZE);
    const rows = Math.floor(window.innerHeight / GIF_SIZE);
    let x, y, key, attempts = 0;
    do {
        const col = Math.floor(Math.random() * cols);
        const row = Math.floor(Math.random() * rows);
        x = col * GIF_SIZE;
        y = row * GIF_SIZE;
        key = `${col}-${row}`;
        attempts++;
        if (attempts > 100) return null;
    } while (usedPositions.includes(key));
    usedPositions.push(key);
    return {x, y};
}

function spawnGlitch(amount) {
    if (document.querySelectorAll(".glitch-gif").length === 0) usedPositions = [];
    const currentCount = document.querySelectorAll(".glitch-gif").length;
    const remaining = MAX_GIFS - currentCount;
    const toSpawn = Math.min(amount, remaining);
    for (let i=0; i<toSpawn; i++) {
        const pos = getRandomPosition();
        if (!pos) break;
        const g = document.createElement("img");
        g.src = "https://i.imgur.com/UsrQHo8.gif";
        g.className = "glitch-gif";
        g.style.left = pos.x + "px";
        g.style.top = pos.y + "px";
        document.body.appendChild(g);
    }
    next();
}

function removeGlitch(percent) {
    let gifs = [...document.querySelectorAll(".glitch-gif")];
    if (percent >= 1) {
        gifs.forEach(g => g.remove());
        usedPositions = [];
    } else {
        const count = Math.floor(gifs.length * percent);
        gifs.sort(() => Math.random() - 0.5).slice(0, count).forEach(g => g.remove());
    }
    next();
}

/* ---------------------- FONCTION FINALE ---------------------- */
function createButton() {
    const button = document.getElementById("final-button");
    button.style.opacity = 0;
    button.style.display = "block";
    setTimeout(() => button.style.opacity = 1, 50);
}

/* ---------------------- SEQUENCE ---------------------- */
const seq = [
    ()=>spawnGlitch(5),
    ()=>spawnGlitch(5),
    ()=>showImage("img5"),
    ()=>removeGlitch(0.5),
    ()=>showImage("img6"),
    ()=>removeGlitch(1),
    ()=>fadeToEnd
];

let seqIndex = 0;
function next() {
    if (seqIndex < seq.length) {
        const f = seq[seqIndex];
        seqIndex++;
        f();
    }
}

/* ---------------------- FIN ---------------------- */
function fadeToEnd() {
    hideAllImages();
    document.body.removeEventListener('click', hideImageAndContinue, true);
    document.body.removeEventListener('click', next);
    setTimeout(createButton, 100); // Affiche le bouton "Dormir" après fin
}

/* ---------------------- LANCEMENT ---------------------- */
document.getElementById("intro-overlay-zone2").onclick = () => {
    document.getElementById("intro-overlay-zone2").style.display = "none";
    next();
    document.body.addEventListener('click', next);
};
</script>
</body>
</html>
