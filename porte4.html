<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Porte 4</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

/* --- RESET & BASE --- */
html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    font-family: 'Press Start 2P', monospace;
    overflow: hidden;
    background: url('https://i.redd.it/5oqqs8imr6s41.gif') center/cover no-repeat;
    user-select: none;
}

/* --- UI ELEMENTS --- */
#back-btn {
    position: fixed; top: 14px; left: 14px;
    font-size: 32px; color: red;
    cursor: pointer; z-index: 6000;
    text-shadow: 2px 2px 0px black;
}

#validate-btn {
    position: fixed; bottom: 15%; left: 50%;
    transform: translateX(-50%);
    padding: 15px 30px;
    font-family: 'Press Start 2P', monospace;
    background: black; color: white;
    border: 3px solid white;
    cursor: pointer;
    text-transform: uppercase;
    font-size: 1em;
    z-index: 50;
}
#validate-btn:active { transform: translateX(-50%) scale(0.95); }

/* --- DIALOGUE --- */
#dialogue-box {
    position: fixed; left: 50%; bottom: 26px;
    transform: translateX(-50%);
    width: 84%;
    min-height: 100px;
    background: rgba(0,0,0,0.8);
    border: 3px solid #ff00ff;
    padding: 18px;
    color: #ff66ff;
    display: none;
    z-index: 9000;
    text-shadow: 0 0 6px rgba(255,0,255,0.4);
    font-size: 0.8em;
    line-height: 1.5;
}

/* --- PUZZLE CONTAINER --- */
#puzzle-container {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    text-align: center;
}

.box-title-text {
    color: white; font-size: 1em;
    text-shadow: 2px 2px 0px black;
    margin-bottom: 20px;
}

/* --- CANVAS & POINTS --- */
#canvas-wrapper {
    position: relative;
    width: 400px; height: 360px;
    border: 4px solid white;
    background: rgba(0, 0, 0, 0.6);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    margin: 0 auto;
}

canvas {
    display: block;
    width: 100%; height: 100%;
}

.point {
    position: absolute;
    width: 16px; height: 16px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    cursor: pointer;
    z-index: 10;
    transition: transform 0.1s;
}
.point:hover { transform: translate(-50%, -50%) scale(1.2); background: white; }
.point.selected {
    background: #ff00ff;
    box-shadow: 0 0 10px #ff00ff;
    border: 2px solid white;
}

/* --- VICTOIRE --- */
#win-image-container {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 5000;
    display: none;
}
#win-img { 
    max-width: 90vw; max-height: 80vh; 
    background: transparent;
}

</style>
</head>
<body>

<audio id="type-sound" src="https://dl.dropboxusercontent.com/scl/fi/r88xcqkfq22gjne9usnea/phoenix-wright-talking-noise-made-with-Voicemod.mp3?rlkey=cuykwz6lmg1wa21zl0aqljobh&dl=0"></audio>

<div id="back-btn" onclick="location.href='zone2_1.html'">⬅</div>

<div id="puzzle-container">
    <div class="box-title-text" style="color:#ff00ff;">Tracez la Rune</div>
    <div id="canvas-wrapper">
        <canvas id="rune-canvas" width="400" height="360"></canvas>
    </div>
</div>

<button id="validate-btn">VALIDER</button>

<div id="win-image-container">
    <img id="win-img" src="https://i.imgur.com/ciRDT96.png" alt="Victoire">
</div>

<div id="dialogue-box"></div>

<script>
/* =========================================
   1. GESTION DES DIALOGUES
   ========================================= */
const dialogueBox = document.getElementById("dialogue-box");
const typeSound = document.getElementById("type-sound");
let typeInterval;

const dialogs = {
    intro: ["C'est quoi, une sorte de puzzle par trie sélectif de traits de caractères ?", "C'est au masculin, j'imagine que c'est pour Guilian. Toujours à mettre le bazard celui la !"],
    win: "Youhou je le connais trop bien je suis juste trop forte en fait !",
    fail: "Mais non mais pas du tout je dit nimp c'est pas du tout lui ça..."
};

function playSound() {
    try { typeSound.currentTime = 0; typeSound.play().catch(()=>{}); } catch(e){}
}

function showDialogue(text, callback = null) {
    clearInterval(typeInterval);
    dialogueBox.style.display = 'block';
    dialogueBox.innerHTML = '';
    playSound();

    let i = 0;
    let currentText = "";
    
    const skipHandler = (e) => {
        e.stopPropation();
        clearInterval(typeInterval);
        dialogueBox.innerHTML = text; 
        finish();
    };
    dialogueBox.onclick = skipHandler;

    function finish() {
        try { typeSound.pause(); } catch(e){}
        dialogueBox.onclick = () => {
            dialogueBox.style.display = 'none';
            dialogueBox.onclick = null;
            if (callback) callback();
        };
    }

    typeInterval = setInterval(() => {
        currentText += text.charAt(i);
        dialogueBox.innerHTML = currentText;
        i++;
        if (i >= text.length) {
            clearInterval(typeInterval);
            finish();
        }
    }, 30);
}

window.onload = () => {
    initPuzzle();
    showDialogue(dialogs.intro[0], () => {
        setTimeout(() => {
            showDialogue(dialogs.intro[1]);
        }, 200);
    });
};


/* =========================================
   2. LOGIQUE DU PUZZLE (RUNE )
   ========================================= */

const COLS = 10;
const SPACING = 40; 
const OFFSET = 20;  

// Uniquement les points actifs nécessaires pour la rune
const POINTS_IDS = [5, 23, 27, 35, 43, 45, 48, 53, 55, 67, 73, 85];

const SOLUTION = [
    '5_23', '5_27', '23_43', '27_35', '35_45', 
    '43_48', '53_73', '55_67', '55_85'
];

let pointsMap = {}; 
let lines = new Set(); 
let selectedPoint = null;

const canvas = document.getElementById('rune-canvas');
const ctx = canvas.getContext('2d');
const wrapper = document.getElementById('canvas-wrapper');

function createPointElement(id) {
    let idx = id - 1;
    let col = idx % COLS;
    let row = Math.floor(idx / COLS);
    
    let x = OFFSET + (col * SPACING);
    let y = OFFSET + (row * SPACING);

    pointsMap[id] = {x, y};

    let p = document.createElement('div');
    p.className = 'point';
    p.style.left = x + 'px';
    p.style.top = y + 'px';
    p.id = 'p-' + id;
    p.dataset.id = id;
    p.onclick = onPointClick;
    
    wrapper.appendChild(p);
}

function initPuzzle() {
    // On ne crée QUE les points actifs
    POINTS_IDS.forEach(id => createPointElement(id));
}

function onPointClick(e) {
    let id = parseInt(this.dataset.id);
    let el = this;

    if (selectedPoint === null) {
        selectedPoint = id;
        el.classList.add('selected');
    } else if (selectedPoint === id) {
        selectedPoint = null;
        el.classList.remove('selected');
    } else {
        toggleLine(selectedPoint, id);
        document.getElementById('p-' + selectedPoint).classList.remove('selected');
        selectedPoint = null;
    }
}

function toggleLine(idA, idB) {
    let key = (idA < idB) ? `${idA}_${idB}` : `${idB}_${idA}`;
    if (lines.has(key)) {
        lines.delete(key);
    } else {
        lines.add(key);
    }
    draw();
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';

    lines.forEach(key => {
        let [a, b] = key.split('_').map(Number);
        let p1 = pointsMap[a];
        let p2 = pointsMap[b];

        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y);
        ctx.lineTo(p2.x, p2.y);
        ctx.stroke();
    });
}

/* =========================================
   3. VALIDATION
   ========================================= */

document.getElementById('validate-btn').onclick = () => {
    let userLines = Array.from(lines).sort();
    let solutionLines = [...SOLUTION].sort();

    if (userLines.length !== solutionLines.length) {
        showDialogue(dialogs.fail);
        return;
    }

    let isCorrect = true;
    for (let i = 0; i < userLines.length; i++) {
        if (userLines[i] !== solutionLines[i]) {
            isCorrect = false;
            break;
        }
    }

    if (isCorrect) {
        document.getElementById('puzzle-container').style.display = 'none';
        document.getElementById('validate-btn').style.display = 'none';
        document.getElementById('win-image-container').style.display = 'block';
        showDialogue(dialogs.win);
    } else {
        showDialogue(dialogs.fail);
    }
};

</script>
</body>
</html>
